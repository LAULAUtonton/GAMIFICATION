<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>THE PIT ‚Äî Games Station</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg1: #bfe7ff;
      --bg2: #0ea5e9;
      --bg3: #082f49;
      --ink: #0b1220;
      --panel: #ffffff;
      --card: #f0f9ff;
      --line: #7dd3fc;
      --brand: #0284c7;
      --ok: #16a34a;
      --bad: #ef4444;
      --warn: #f59e0b;
      --shadow: 0 22px 60px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Orbitron', system-ui, sans-serif;
      background: radial-gradient(circle, var(--bg1) 0%, var(--bg2) 55%, var(--bg3) 100%);
      color: var(--ink);
      min-height: 100vh;
      padding: 14px;
    }
    .app {
      width: min(1200px, calc(100vw - 28px));
      margin: 0 auto;
      background: var(--panel);
      border-radius: 28px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.35);
      overflow: hidden;
    }
    .topbar {
      padding: 18px 18px 14px;
      background: rgba(255,255,255,.65);
      border-bottom: 1px solid rgba(2,132,199,.18);
      backdrop-filter: blur(8px);
    }
    h1 { margin: 0; text-align: center; letter-spacing: 2px; font-size: clamp(18px, 3.6vw, 30px); color: #083344; }
    .sub { margin: 8px 0 0; text-align: center; color: #075985; font-size: 12px; line-height: 1.35; font-weight: 700; }

    .screen { display: none; padding: 16px 16px 18px; }
    .screen.active { display: block; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin-top: 10px; }
    .card { background: var(--card); border: 2px solid var(--line); border-radius: 18px; padding: 14px; display: flex; flex-direction: column; gap: 10px; min-height: 168px; }
    .card h3 { margin: 0; color: #083344; font-size: 16px; letter-spacing: .4px; }
    .card p { margin: 0; font-size: 12px; color: #075985; line-height: 1.5; font-weight: 700; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-top: auto; }

    .btn { border: none; border-radius: 14px; padding: 12px 14px; font-weight: 900; cursor: pointer; font-family: inherit; letter-spacing: .3px; transition: transform .08s ease, filter .12s ease; user-select: none; }
    .btn:hover { filter: brightness(1.06); }
    .btn:active { transform: translateY(1px); }
    .primary { background: var(--brand); color: #fff; }
    .soft { background: #ffffff; border: 2px solid var(--line); color: #083344; }

    .gameHeader { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .pillRow { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .pill { background: #e0f2fe; border: 2px solid var(--line); border-radius: 999px; padding: 9px 11px; font-size: 11px; font-weight: 900; color: #083344; white-space: nowrap; }
    .info { width: 100%; background: #e0f2fe; border: 2px solid var(--line); border-radius: 16px; padding: 10px 12px; font-size: 12px; font-weight: 800; color: #075985; line-height: 1.35; }

    .gameWrap { display: grid; grid-template-columns: minmax(0, 1fr) 300px; gap: 12px; align-items: start; margin-top: 10px; }

    .boardWrap { overflow-x: auto; }
    .board {
      background: #020617;
      border: 2px solid rgba(14,165,233,.95);
      border-radius: 18px;
      padding: 10px;
      display: grid;
      gap: 3px;
      user-select: none;
      box-shadow: inset 0 0 0 1px rgba(56,189,248,.35), 0 0 22px rgba(14,165,233,.22);
      width: max-content;
    }

    .cell {
      width: 56px;
      height: 56px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      line-height: 1.1;
      font-weight: 900;
      padding: 3px;
      border: 1px solid rgba(125,211,252,.28);
      background: rgba(14,165,233,.06);
      color: rgba(255,255,255,.92);
      position: relative;
      overflow: hidden;
      font-size: 10px;
    }
    .cell.wall {
      background: rgba(59,130,246,.22);
      border-color: rgba(59,130,246,.25);
    }
    .cell.word {
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.28);
      color: #fff;
      font-size: 11px;
    }

    /* PAC-MAN ‚Äî yellow circle with chomp animation and direction rotation */
    .cell.pac::before {
      content: "";
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #facc15;
      position: absolute;
      box-shadow: 0 0 12px rgba(250,204,21,.65);
      transform: rotate(var(--rot, 0deg));
      clip-path: polygon(50% 50%, 100% 30%, 100% 0, 0 0, 0 100%, 100% 100%, 100% 70%);
      animation: chomp .22s ease-in-out infinite alternate;
    }
    @keyframes chomp {
      from { clip-path: polygon(50% 50%, 100% 28%, 100% 0, 0 0, 0 100%, 100% 100%, 100% 72%); }
      to   { clip-path: polygon(50% 50%, 100% 49%, 100% 0, 0 0, 0 100%, 100% 100%, 100% 51%); }
    }

    /* GHOSTS ‚Äî classic ghost body + eyes */
    .cell.ghost-blue::before,
    .cell.ghost-pink::before {
      content: "";
      width: 34px;
      height: 36px;
      border-radius: 17px 17px 0 0;
      position: absolute;
      clip-path: polygon(0 0, 100% 0, 100% 82%, 86% 100%, 72% 82%, 58% 100%, 44% 82%, 30% 100%, 16% 82%, 0 100%);
    }
    .cell.ghost-blue::before { background: #2563eb; box-shadow: 0 0 12px rgba(37,99,235,.55); }
    .cell.ghost-pink::before { background: #f472b6; box-shadow: 0 0 12px rgba(244,114,182,.55); }
    .cell.ghost-blue::after,
    .cell.ghost-pink::after {
      content: "‚óâ ‚óâ";
      position: absolute;
      top: 10px;
      color: #f8fafc;
      font-size: 10px;
      letter-spacing: 2px;
      font-weight: 900;
    }

    .side { background: var(--card); border: 2px solid var(--line); border-radius: 18px; padding: 12px; }
    .side h4 { margin: 0 0 8px; color: #083344; font-size: 12px; letter-spacing: .6px; text-transform: uppercase; }
    .progressRow { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0 10px; }
    .slot { min-width: 32px; padding: 7px 7px; border-radius: 10px; border: 1px dashed rgba(2,132,199,.35); background: rgba(255,255,255,.6); font-weight: 900; text-align: center; color: rgba(7,89,133,.75); font-size: 11px; }
    .slot.filled { border-style: solid; border-color: rgba(22,163,74,.45); background: rgba(22,163,74,.12); color: #083344; }

    .feedback { min-height: 26px; font-size: 12px; font-weight: 900; line-height: 1.25; margin-top: 8px; color: #075985; }
    .feedback.ok { color: var(--ok); }
    .feedback.bad { color: var(--bad); }
    .feedback.warn { color: var(--warn); }

    .guide { background: #e0f2fe; border: 2px solid var(--line); border-radius: 14px; padding: 10px; color: #0b4f73; font-size: 12px; font-weight: 800; line-height: 1.4; margin-bottom: 10px; }
    .guide b { color: #083344; }

    .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; max-width: 240px; margin-top: 10px; }
    .controls .btn { padding: 10px 10px; border-radius: 14px; }

    .revealToggle { display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 800; color: #075985; margin-top: 10px; cursor: pointer; }
    .revealToggle input { cursor: pointer; width: 15px; height: 15px; }

    .small { font-size: 11px; color: #075985; font-weight: 800; line-height: 1.35; margin-top: 10px; }

    @media (max-width: 980px) { .gameWrap { grid-template-columns: 1fr; } }
    @media (max-width: 640px) {
      .cell { width: 40px; height: 40px; font-size: 8px; }
      .cell.word { font-size: 9px; }
      .cell.pac::before { width: 28px; height: 28px; }
      .cell.ghost-blue::before,
      .cell.ghost-pink::before { width: 24px; height: 26px; }
    }
  </style>
</head>

<body>
  <main class="app">
    <header class="topbar">
      <h1>THE PIT ‚Äî GAMES STATION</h1>
      <p class="sub">
        Choose difficulty then play PacSentence. The aim is shown ‚Äî the answers are not.
      </p>
    </header>

    <!-- ‚îÄ‚îÄ MENU SCREEN ‚îÄ‚îÄ -->
    <section id="menuScreen" class="screen active">
      <div class="grid">
        <article class="card">
          <h3>üü® PacSentence (Classic)</h3>
          <p>
            Yellow Pac-Man with animated chomp mouth. Blue ghost on Easy.
            Blue + pink ghosts on Hard. Eat the right words to win each round.
          </p>
          <div class="row">
            <button id="startEasyBtn" class="btn primary">‚ñ∂ Start Easy</button>
            <button id="startHardBtn" class="btn primary" style="background:#7c3aed;">‚ñ∂ Start Hard</button>
            <button class="btn soft" onclick="location.href='../index.html'">Main menu</button>
          </div>
        </article>

        <article class="card">
          <h3>üéØ Learning objectives</h3>
          <p>
            Each round assigns one of four objectives: <b>Word order</b>,
            <b>Past-tense verbs</b>, Adjectives, or Nouns. Eat target words,
            avoid the rest. Answers stay hidden until you fail.
          </p>
          <div class="row">
            <span class="btn soft" style="cursor:default;opacity:.55;">Answers hidden</span>
            <span class="btn soft" style="cursor:default;opacity:.55;">Revealed on fail</span>
          </div>
        </article>
      </div>
    </section>

    <!-- ‚îÄ‚îÄ GAME SCREEN ‚îÄ‚îÄ -->
    <section id="pacScreen" class="screen">
      <div class="gameHeader">
        <div class="pillRow">
          <div class="pill">Time: <span id="timerDisplay">00:00</span></div>
          <div class="pill">Lives: <span id="livesDisplay">3</span></div>
          <div class="pill">Objective: <span id="objectiveDisplay">-</span></div>
          <div class="pill">Rounds: <span id="roundsDisplay">0</span></div>
          <div class="pill">Status: <span id="statusDisplay">In play</span></div>
          <div class="pill">Level: <span id="levelDisplay">Easy</span></div>
        </div>
        <div class="pillRow">
          <button id="backToMenu" class="btn soft">‚Üê Back</button>
          <button id="restartGame" class="btn soft">‚Ü∫ Restart</button>
          <button id="nextSentence" class="btn primary">Next round ‚ñ∂</button>
        </div>
      </div>

      <div id="assignInfo" class="info">
        Game: PacSentence ¬∑ Objective: <b id="assignObjective">Word order</b>
      </div>

      <div class="gameWrap">
        <div>
          <div class="boardWrap">
            <div id="board" class="board" aria-label="PacSentence board"></div>
          </div>
          <p class="small">
            Move with <b>‚Üê ‚Üë ‚Üí ‚Üì</b> or WASD or the buttons below.
            Avoid ghosts and eat the correct words to complete the objective.
          </p>
        </div>

        <aside class="side">
          <h4>Round objective</h4>
          <div class="guide">
            <b>Aim:</b> <span id="sideObjective">Eat words in sentence order.</span><br>
            <b>Tip:</b> Next target shown in the HUD above.
          </div>

          <h4>Progress</h4>
          <div id="progressRow" class="progressRow"></div>

          <div id="feedback" class="feedback">Press "Next round" to start.</div>

          <div class="controls" aria-label="Controls">
            <span></span>
            <button class="btn soft" data-dir="up">‚Üë</button>
            <span></span>
            <button class="btn soft" data-dir="left">‚Üê</button>
            <button class="btn soft" data-dir="down">‚Üì</button>
            <button class="btn soft" data-dir="right">‚Üí</button>
          </div>

          <label class="revealToggle">
            <input type="checkbox" id="revealToggle">
            Teacher: reveal answer on fail
          </label>
        </aside>
      </div>
    </section>
  </main>

  <script>
  (function () {
    "use strict";

    // ‚îÄ‚îÄ SENTENCE DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var ORDER_SENTENCES = [
      "Can you solve this puzzle before lunchtime",
      "Do they study English after soccer practice",
      "Will your team finish homework before dinner",
      "Are we meeting classmates at the library",
      "Does she always carry pencils in class",
      "Can birds really fly above city buildings",
      "Will they present projects during science class",
      "Do you usually read novels after school"
    ];

    var HARD_ORDER_SENTENCES = [
      "Although it was raining we finished homework before dinner",
      "If they study consistently they can solve harder grammar tasks",
      "After she revised carefully she answered every question correctly",
      "Because the timer was short we prioritized the key clues",
      "When students collaborate effectively they build stronger sentence accuracy",
      "Even if words look similar context usually reveals correct order",
      "Before the bell rang our team completed the full challenge",
      "While the ghosts moved faster we still stayed focused together"
    ];

    var CATEGORY_TASKS = [
      {
        prompt: "Find all past-tense verbs",
        words: ["played", "walked", "was", "jumped", "studied", "cooked", "teacher", "happy", "window", "city"],
        targets: ["played", "walked", "was", "jumped", "studied", "cooked"]
      },
      {
        prompt: "Find all past-tense verbs",
        words: ["wrote", "sang", "visited", "opened", "ran", "spoke", "quickly", "beautiful", "table", "school"],
        targets: ["wrote", "sang", "visited", "opened", "ran", "spoke"]
      },
      {
        prompt: "Find all adjectives",
        words: ["beautiful", "small", "blue", "happy", "ancient", "quiet", "table", "teacher", "running", "school"],
        targets: ["beautiful", "small", "blue", "happy", "ancient", "quiet"]
      },
      {
        prompt: "Find all nouns",
        words: ["book", "teacher", "school", "window", "river", "planet", "quickly", "jumped", "beautiful", "blue"],
        targets: ["book", "teacher", "school", "window", "river", "planet"]
      }
    ];

    // ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var GRID = 10;
    var TILE_PX = 56;
    var WALL_DENSITY = 0.12;

    // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var state = {
      level: "easy",
      running: false,
      grid: [],
      words: [],
      tokens: [],
      expected: 0,
      targetsSet: null,
      foundTargets: null,
      mode: "order",
      prompt: "",
      currentSentence: "",
      pac: { x: 1, y: 1, dir: "right" },
      ghosts: [],
      lives: 3,
      seconds: 0,
      phrasesDone: 0,
      statusText: "In play",
      timerRef: null,
      ghostRef: null,
      lastMoveAt: 0
    };

    // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function $(id) { return document.getElementById(id); }

    function shuffle(arr) {
      var a = arr.slice();
      for (var i = a.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = a[i]; a[i] = a[j]; a[j] = tmp;
      }
      return a;
    }

    function pad2(n) { return String(n).padStart(2, "0"); }

    function setScreen(name) {
      $("menuScreen").classList.remove("active");
      $("pacScreen").classList.remove("active");
      $(name + "Screen").classList.add("active");
    }

    function setFB(msg, cls) {
      var fb = $("feedback");
      fb.className = "feedback" + (cls ? " " + cls : "");
      fb.textContent = msg;
    }

    function objectiveLabel() {
      if (state.mode === "order") {
        var next = state.tokens[state.expected] || "‚Äî";
        return "Word order ¬∑ next: \u201c" + next + "\u201d";
      }
      return state.prompt;
    }

    function updateHUD() {
      $("timerDisplay").textContent = pad2(Math.floor(state.seconds / 60)) + ":" + pad2(state.seconds % 60);
      $("livesDisplay").textContent = String(state.lives);
      $("objectiveDisplay").textContent = objectiveLabel();
      $("roundsDisplay").textContent = String(state.phrasesDone);
      $("statusDisplay").textContent = state.statusText;
      $("levelDisplay").textContent = state.level === "hard" ? "Hard" : "Easy";
      $("sideObjective").textContent = objectiveLabel();
    }

    // ‚îÄ‚îÄ GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildGrid() {
      var g = [];
      var y, x;
      for (y = 0; y < GRID; y++) {
        g[y] = [];
        for (x = 0; x < GRID; x++) { g[y][x] = 0; }
      }
      // Border walls
      for (x = 0; x < GRID; x++) { g[0][x] = 1; g[GRID - 1][x] = 1; }
      for (y = 0; y < GRID; y++) { g[y][0] = 1; g[y][GRID - 1] = 1; }
      // Random inner walls (skip spawn corners)
      for (y = 1; y < GRID - 1; y++) {
        for (x = 1; x < GRID - 1; x++) {
          if ((x === 1 && y === 1) || (x === GRID - 2 && y === GRID - 2) || (x === GRID - 2 && y === 1)) continue;
          if (Math.random() < WALL_DENSITY) g[y][x] = 1;
        }
      }
      // Clear 2x2 spawn zones
      for (y = 1; y <= 2; y++) for (x = 1; x <= 2; x++) g[y][x] = 0;
      for (y = GRID - 3; y <= GRID - 2; y++) for (x = GRID - 3; x <= GRID - 2; x++) g[y][x] = 0;
      state.grid = g;
    }

    function emptyCells() {
      var cells = [];
      for (var y = 1; y < GRID - 1; y++) {
        for (var x = 1; x < GRID - 1; x++) {
          if (state.grid[y][x] === 0) cells.push({ x: x, y: y });
        }
      }
      return cells;
    }

    // ‚îÄ‚îÄ ROUNDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function makeRound() {
      var categoryMode = Math.random() < 0.45;
      var cells, items, i;

      if (categoryMode) {
        var task = CATEGORY_TASKS[Math.floor(Math.random() * CATEGORY_TASKS.length)];
        state.mode = "category";
        state.prompt = task.prompt;
        state.currentSentence = task.prompt;
        state.tokens = task.words.slice();
        state.targetsSet = {};
        state.foundTargets = {};
        for (i = 0; i < task.targets.length; i++) state.targetsSet[task.targets[i]] = true;
        state.expected = 0;

        items = shuffle(task.words.map(function (w) { return { word: w, isTarget: !!state.targetsSet[w] }; }));
        cells = shuffle(emptyCells().filter(function (c) {
          return !(c.x === 1 && c.y === 1) && !(c.x === GRID - 2 && c.y === GRID - 2);
        }));
        state.words = items.slice(0, Math.min(items.length, cells.length)).map(function (it, idx) {
          return { word: it.word, idx: -1, isCorrect: it.isTarget, eaten: false, x: cells[idx].x, y: cells[idx].y };
        });
      } else {
        var bank = state.level === "hard" ? HARD_ORDER_SENTENCES : ORDER_SENTENCES;
        var sentence = bank[Math.floor(Math.random() * bank.length)];
        state.mode = "order";
        state.prompt = "";
        state.currentSentence = sentence;
        state.tokens = sentence.trim().split(/\s+/);
        state.expected = 0;
        state.targetsSet = {};
        state.foundTargets = {};

        var pool = {};
        bank.forEach(function (s) {
          if (s !== sentence) s.trim().split(/\s+/).forEach(function (w) { pool[w] = true; });
        });
        var distractors = shuffle(Object.keys(pool)).slice(0, 2);
        var sentenceItems = state.tokens.map(function (w, idx) { return { word: w, idx: idx, isCorrect: true }; });
        var distItems = distractors.map(function (w) { return { word: w, idx: -1, isCorrect: false }; });
        items = shuffle(sentenceItems.concat(distItems));

        cells = shuffle(emptyCells().filter(function (c) {
          return !(c.x === 1 && c.y === 1) && !(c.x === GRID - 2 && c.y === GRID - 2);
        }));
        state.words = items.slice(0, Math.min(items.length, cells.length)).map(function (it, idx) {
          return { word: it.word, idx: it.idx, isCorrect: it.isCorrect, eaten: false, x: cells[idx].x, y: cells[idx].y };
        });
      }

      var objLabel = state.mode === "order" ? "Word order" : state.prompt;
      $("assignObjective").textContent = objLabel;
    }

    function countTargets() {
      return Object.keys(state.targetsSet).length;
    }
    function countFound() {
      return Object.keys(state.foundTargets).length;
    }

    function buildProgress() {
      var row = $("progressRow");
      row.innerHTML = "";
      var total = state.mode === "order" ? state.tokens.length : countTargets();
      var done = state.mode === "order" ? state.expected : countFound();
      for (var i = 0; i < total; i++) {
        var d = document.createElement("div");
        d.className = "slot" + (i < done ? " filled" : "");
        d.textContent = i < done ? "\u2713" : "_";
        row.appendChild(d);
      }
    }

    // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function render() {
      var board = $("board");
      board.style.gridTemplateColumns = "repeat(" + GRID + ", " + TILE_PX + "px)";
      board.style.gridAutoRows = TILE_PX + "px";
      board.innerHTML = "";
      var ROT = { right: "0deg", down: "90deg", left: "180deg", up: "270deg" };
      var y, x, gi;

      for (y = 0; y < GRID; y++) {
        for (x = 0; x < GRID; x++) {
          var cell = document.createElement("div");
          cell.className = "cell";

          if (state.grid[y][x] === 1) {
            cell.classList.add("wall");
          } else {
            // Place word if uneaten word is here
            for (var wi = 0; wi < state.words.length; wi++) {
              var w = state.words[wi];
              if (!w.eaten && w.x === x && w.y === y) {
                cell.classList.add("word");
                var text = w.word;
                cell.textContent = text.length > 9 ? text.slice(0, 9) : text;
                cell.style.fontSize = text.length <= 6 ? "12px" : (text.length <= 9 ? "11px" : "9px");
                break;
              }
            }
          }

          // Draw ghosts (overrides word display)
          for (gi = 0; gi < state.ghosts.length; gi++) {
            var g = state.ghosts[gi];
            if (g.x === x && g.y === y) {
              cell.classList.add(g.color === "pink" ? "ghost-pink" : "ghost-blue");
              cell.textContent = "";
            }
          }

          // Draw Pac-Man (overrides everything)
          if (state.pac.x === x && state.pac.y === y) {
            cell.classList.add("pac");
            cell.textContent = "";
            cell.style.setProperty("--rot", ROT[state.pac.dir] || "0deg");
          }

          board.appendChild(cell);
        }
      }
    }

    // ‚îÄ‚îÄ GHOST MOVEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function moveGhost(g) {
      var dx = state.pac.x - g.x;
      var dy = state.pac.y - g.y;
      var stepX = 0, stepY = 0;
      if (Math.abs(dx) >= Math.abs(dy) && dx !== 0) stepX = dx > 0 ? 1 : -1;
      else if (dy !== 0) stepY = dy > 0 ? 1 : -1;

      var candidates = [
        { x: g.x + stepX, y: g.y + stepY },
        { x: g.x + (dx > 0 ? 1 : dx < 0 ? -1 : 0), y: g.y },
        { x: g.x, y: g.y + (dy > 0 ? 1 : dy < 0 ? -1 : 0) },
        { x: g.x + 1, y: g.y }, { x: g.x - 1, y: g.y },
        { x: g.x, y: g.y + 1 }, { x: g.x, y: g.y - 1 }
      ];
      for (var ci = 0; ci < candidates.length; ci++) {
        var c = candidates[ci];
        if (c.x < 1 || c.y < 1 || c.x > GRID - 2 || c.y > GRID - 2) continue;
        if (state.grid[c.y][c.x] === 1) continue;
        g.x = c.x; g.y = c.y;
        return;
      }
    }

    function moveGhosts() {
      for (var i = 0; i < state.ghosts.length; i++) moveGhost(state.ghosts[i]);
    }

    function checkCollision() {
      if (!state.running) return;
      var hit = false;
      for (var i = 0; i < state.ghosts.length; i++) {
        if (state.ghosts[i].x === state.pac.x && state.ghosts[i].y === state.pac.y) { hit = true; break; }
      }
      if (!hit) return;
      state.lives--;
      updateHUD();
      if (state.lives <= 0) { loseRound("\uD83D\uDC7B A ghost caught you."); return; }
      state.pac = { x: 1, y: 1, dir: "right" };
      setFB("\uD83D\uDC7B A ghost touched you. You lose 1 life.", "warn");
    }

    // ‚îÄ‚îÄ LOOPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function stopLoops() {
      clearInterval(state.timerRef);
      clearInterval(state.ghostRef);
      state.timerRef = null;
      state.ghostRef = null;
    }

    function startLoops() {
      stopLoops();
      state.timerRef = setInterval(function () {
        if (!state.running) return;
        state.seconds++;
        updateHUD();
      }, 1000);
      var ghostTick = state.level === "hard" ? 600 : 980;
      state.ghostRef = setInterval(function () {
        if (!state.running) return;
        moveGhosts();
        checkCollision();
        render();
      }, ghostTick);
    }

    // ‚îÄ‚îÄ GAME FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function resetPositions() {
      state.pac = { x: 1, y: 1, dir: "right" };
      if (state.level === "hard") {
        state.ghosts = [
          { x: GRID - 2, y: GRID - 2, color: "blue" },
          { x: GRID - 2, y: 1, color: "pink" }
        ];
      } else {
        state.ghosts = [{ x: GRID - 2, y: GRID - 2, color: "blue" }];
      }
    }

    function startGame(level) {
      if (level) state.level = level;
      buildGrid();
      resetPositions();
      state.seconds = 0;
      state.lives = 3;
      state.phrasesDone = 0;
      state.statusText = "In play";
      state.running = true;
      makeRound();
      buildProgress();
      updateHUD();
      render();
      setFB("Complete the objective and avoid the ghosts!", "ok");
      startLoops();
    }

    function nextSentence() {
      buildGrid();
      resetPositions();
      state.seconds = 0;
      state.statusText = "In play";
      state.running = true;
      makeRound();
      buildProgress();
      updateHUD();
      render();
      setFB("New round started.", "ok");
      startLoops();
    }

    function move(dir) {
      if (!state.running) return;
      var now = Date.now();
      if (now - state.lastMoveAt < 85) return;
      state.lastMoveAt = now;
      var vectors = { up: [0, -1], down: [0, 1], left: [-1, 0], right: [1, 0] };
      var v = vectors[dir];
      if (!v) return;
      state.pac.dir = dir;
      var nx = state.pac.x + v[0];
      var ny = state.pac.y + v[1];
      if (nx < 0 || ny < 0 || nx >= GRID || ny >= GRID) return;
      if (state.grid[ny][nx] === 1) { render(); return; }
      state.pac.x = nx;
      state.pac.y = ny;
      eatIfWord();
      checkCollision();
      render();
    }

    function eatIfWord() {
      var item = null;
      for (var i = 0; i < state.words.length; i++) {
        var w = state.words[i];
        if (!w.eaten && w.x === state.pac.x && w.y === state.pac.y) { item = w; break; }
      }
      if (!item) return;

      if (state.mode === "order") {
        var expected = state.tokens[state.expected];
        if (item.isCorrect && item.idx === state.expected && item.word === expected) {
          item.eaten = true;
          state.expected++;
          buildProgress();
          updateHUD();
          if (state.expected >= state.tokens.length) { finishRound(); return; }
          setFB("\u2705 Correct word! Keep going.", "ok");
        } else {
          item.eaten = true;
          state.lives--;
          updateHUD();
          if (state.lives <= 0) { loseRound("\uD83D\uDCA5 No lives left."); return; }
          setFB("\u274C Wrong order. Expected: \u201c" + expected + "\u201d.", "bad");
        }
      } else {
        if (item.isCorrect) {
          item.eaten = true;
          state.foundTargets[item.word] = true;
          buildProgress();
          if (countFound() >= countTargets()) { finishRound(); return; }
          setFB("\u2705 Found a target word! Keep going.", "ok");
        } else {
          item.eaten = true;
          state.lives--;
          updateHUD();
          if (state.lives <= 0) { loseRound("\uD83D\uDCA5 No lives left."); return; }
          setFB("\u274C That word is not in the target category.", "bad");
        }
      }
    }

    function finishRound() {
      state.running = false;
      stopLoops();
      state.phrasesDone++;
      state.statusText = "Round complete";
      updateHUD();
      setFB("\uD83C\uDFC6 Correct! Press \u201cNext round\u201d to continue.", "ok");
    }

    function loseRound(message) {
      state.running = false;
      stopLoops();
      state.statusText = "You lost";
      updateHUD();
      var reveal = "";
      if ($("revealToggle").checked) {
        reveal = state.mode === "order"
          ? " Correct order: " + state.currentSentence
          : " Target words: " + Object.keys(state.targetsSet).join(", ");
      }
      setFB(message + reveal, "bad");
    }

    // ‚îÄ‚îÄ EVENT LISTENERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    $("startEasyBtn").addEventListener("click", function () { setScreen("pac"); startGame("easy"); });
    $("startHardBtn").addEventListener("click", function () { setScreen("pac"); startGame("hard"); });
    $("backToMenu").addEventListener("click", function () { state.running = false; stopLoops(); setScreen("menu"); });
    $("restartGame").addEventListener("click", function () { startGame(state.level); });
    $("nextSentence").addEventListener("click", function () { nextSentence(); });

    document.querySelectorAll("[data-dir]").forEach(function (btn) {
      btn.addEventListener("click", function () { move(btn.dataset.dir); });
    });

    window.addEventListener("keydown", function (e) {
      var map = {
        ArrowUp: "up", ArrowDown: "down", ArrowLeft: "left", ArrowRight: "right",
        w: "up", W: "up", s: "down", S: "down", a: "left", A: "left", d: "right", D: "right"
      };
      if (!map[e.key]) return;
      e.preventDefault();
      move(map[e.key]);
    });

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    updateHUD();
  }());
  </script>
</body>
</html>
